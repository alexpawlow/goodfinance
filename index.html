<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FinanÃ§as de Boa</title>
    
    <!-- ConfiguraÃ§Ãµes para iPhone (Web App) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FinanÃ§as">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Plus+Jakarta+Sans', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            padding-bottom: 120px;
        }

        .glass-card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .btn-primary {
            background-color: #ec4899;
            color: white;
            transition: all 0.2s;
        }

        .btn-primary:active { transform: scale(0.95); opacity: 0.9; }

        .btn-secondary {
            background-color: #10b981;
            color: white;
        }

        .nav-active { color: #ec4899 !important; font-weight: 700; }
        
        header { padding-top: env(safe-area-inset-top, 20px); }
        nav { padding-bottom: env(safe-area-inset-bottom, 20px); }

        #toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown { from { transform: translate(-50%, -20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        .modal-enter { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- Toast de NotificaÃ§Ã£o -->
    <div id="toast" class="bg-slate-800 text-white px-6 py-3 rounded-full text-sm font-bold shadow-2xl flex items-center gap-2">
        <i data-lucide="check" class="w-4 h-4 text-emerald-400"></i>
        <span id="toast-text">Salvo com sucesso!</span>
    </div>

    <!-- Bloqueio por PIN -->
    <div id="lock-screen" class="fixed inset-0 bg-white z-[200] flex flex-col items-center justify-center p-6 hidden">
        <div class="text-center space-y-4 max-w-xs w-full">
            <div class="bg-pink-100 text-pink-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="lock" class="w-8 h-8"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-800">PIN de Acesso</h2>
            <input type="password" id="unlock-pass" class="w-full border-2 border-slate-200 p-4 rounded-2xl text-center text-3xl outline-none focus:border-pink-400" placeholder="â€¢â€¢â€¢â€¢" inputmode="numeric">
            <button onclick="unlockApp()" class="w-full btn-primary py-4 rounded-2xl font-bold text-lg shadow-lg">Entrar</button>
        </div>
    </div>

    <!-- Header -->
    <header class="p-6 bg-white border-b sticky top-0 z-50">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div onclick="toggleView('home')" class="cursor-pointer">
                <h1 class="text-xl font-bold text-gray-900">FinanÃ§as de Boa âœ¨</h1>
                <p class="text-xs text-gray-500" id="header-subtitle">Boas vindas!</p>
            </div>
            <button onclick="toggleView('settings')" class="p-2 text-gray-400 hover:text-pink-500 transition">
                <i data-lucide="user-circle"></i>
            </button>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4 space-y-6">
        
        <!-- DASHBOARD (HOME) -->
        <section id="view-home" class="space-y-6">
            <div class="glass-card rounded-3xl p-6 text-center border-b-4 border-pink-100">
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Saldo Atual</p>
                <h2 class="text-4xl font-extrabold text-gray-900 my-2" id="total-balance">R$ 0,00</h2>
                <div class="flex justify-between mt-6 border-t pt-4">
                    <div class="text-emerald-600">
                        <span class="text-[10px] block font-bold opacity-50 uppercase tracking-tighter">Entradas</span>
                        <span id="total-income" class="font-bold text-lg">R$ 0,00</span>
                    </div>
                    <div class="text-rose-600">
                        <span class="text-[10px] block font-bold opacity-50 uppercase tracking-tighter">SaÃ­das</span>
                        <span id="total-expense" class="font-bold text-lg">R$ 0,00</span>
                    </div>
                </div>
            </div>

            <div id="evolution-container" class="glass-card rounded-3xl p-6 hidden">
                <h3 class="font-bold text-gray-800 mb-4 text-sm flex items-center gap-2">
                    <i data-lucide="bar-chart-2" class="w-4 h-4 text-pink-500"></i> EvoluÃ§Ã£o DiÃ¡ria
                </h3>
                <div class="h-[180px]"><canvas id="evolutionChart"></canvas></div>
            </div>

            <div id="chart-empty" class="p-10 text-center border-2 border-dashed border-gray-200 rounded-3xl">
                <p class="text-sm text-gray-400 italic">Nada por aqui. Adicione um gasto! ðŸŒ¸</p>
            </div>

            <div class="flex gap-4">
                <button onclick="openModal('expense')" class="flex-1 btn-primary font-bold py-5 rounded-3xl shadow-lg flex items-center justify-center gap-2">
                    <i data-lucide="minus"></i> Gasto
                </button>
                <button onclick="openModal('income')" class="flex-1 btn-secondary font-bold py-5 rounded-3xl shadow-lg flex items-center justify-center gap-2">
                    <i data-lucide="plus"></i> Entrada
                </button>
            </div>
        </section>

        <!-- EXTRATO -->
        <section id="view-list" class="hidden space-y-4">
            <h3 class="text-lg font-bold text-gray-800">Extrato Detalhado</h3>
            <div id="category-list" class="space-y-4"></div>
        </section>

        <!-- PLANEJAMENTO FUTURO -->
        <section id="view-future" class="hidden space-y-6">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-bold text-gray-800">Gastos Futuros</h3>
                <button onclick="openFutureModal()" class="text-pink-600 text-sm font-bold">+ Novo</button>
            </div>
            <div id="future-list" class="space-y-3"></div>
        </section>

        <!-- METAS -->
        <section id="view-goals" class="hidden space-y-6">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-bold text-gray-800">Metas</h3>
                <button onclick="openGoalModal()" class="btn-primary px-4 py-2 rounded-xl text-xs font-bold shadow-md">Nova Meta</button>
            </div>
            <div id="goals-container" class="space-y-4"></div>
        </section>

        <!-- IA -->
        <section id="view-import" class="hidden space-y-6">
            <div class="bg-pink-50 p-6 rounded-3xl border border-pink-100">
                <h3 class="font-bold text-pink-800 flex items-center gap-2"><i data-lucide="sparkles"></i> Conselheiro IA</h3>
                <button onclick="generateAdvice()" class="w-full mt-4 bg-pink-600 text-white font-bold py-4 rounded-2xl shadow-md">Analisar agora</button>
                <div id="advice-result" class="hidden mt-4 p-4 bg-white rounded-2xl text-sm italic"></div>
            </div>
            <div class="bg-indigo-50 p-6 rounded-3xl border border-indigo-100">
                <h3 class="font-bold text-indigo-800 flex items-center gap-2"><i data-lucide="upload-cloud"></i> Importar Texto</h3>
                <textarea id="import-input" class="w-full mt-4 h-32 p-4 rounded-2xl border-2 border-indigo-200 outline-none text-sm" placeholder="Cole o extrato aqui..."></textarea>
                <button onclick="processMagicImport()" class="w-full mt-4 bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-md">Analisar com IA</button>
            </div>
        </section>

        <!-- CONFIG -->
        <section id="view-settings" class="hidden space-y-6">
            <div class="glass-card rounded-3xl p-8 space-y-4">
                <h3 class="font-bold text-gray-800 border-b pb-2">Seu Perfil</h3>
                <input type="text" id="set-user-name" class="w-full border-b py-2 outline-none text-sm" placeholder="Nome">
                <input type="password" id="set-user-pass" class="w-full border-b py-2 outline-none text-sm" placeholder="PIN Novo" inputmode="numeric">
                <button onclick="saveSettings()" class="w-full btn-primary py-4 rounded-2xl font-bold mt-4 shadow-lg">Salvar</button>
                <button onclick="clearAllData()" class="w-full text-xs text-rose-300 font-bold py-10">Apagar dados deste dispositivo</button>
            </div>
        </section>
    </main>

    <!-- NavegaÃ§Ã£o Inferior -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around p-3 pb-10 max-w-md mx-auto z-[60] shadow-[0_-4px_12px_rgba(0,0,0,0.02)]">
        <button onclick="toggleView('home')" class="nav-btn nav-active flex flex-col items-center gap-1"><i data-lucide="home"></i><span class="text-[10px]">Home</span></button>
        <button onclick="toggleView('list')" class="nav-btn text-gray-400 flex flex-col items-center gap-1"><i data-lucide="receipt"></i><span class="text-[10px]">Extrato</span></button>
        <button onclick="toggleView('future')" class="nav-btn text-gray-400 flex flex-col items-center gap-1"><i data-lucide="calendar"></i><span class="text-[10px]">Futuro</span></button>
        <button onclick="toggleView('goals')" class="nav-btn text-gray-400 flex flex-col items-center gap-1"><i data-lucide="target"></i><span class="text-[10px]">Metas</span></button>
        <button onclick="toggleView('import')" class="nav-btn text-gray-400 flex flex-col items-center gap-1"><i data-lucide="sparkles"></i><span class="text-[10px]">IA</span></button>
    </nav>

    <!-- Modais -->
    <div id="modal-transaction" class="fixed inset-0 bg-black/50 hidden z-[100] flex items-end justify-center">
        <div class="bg-white w-full max-w-sm rounded-t-[40px] p-8 space-y-6 modal-enter">
            <div class="flex justify-between items-center"><h3 id="modal-title" class="font-bold text-xl">Novo Registro</h3><button onclick="closeModal()" class="text-gray-300 p-2"><i data-lucide="x"></i></button></div>
            <div class="space-y-4">
                <input type="text" id="input-amount" class="w-full text-4xl font-black border-b-2 py-2 outline-none" placeholder="0,00" inputmode="decimal">
                <input type="text" id="input-desc" class="w-full border-b py-3 outline-none" placeholder="O que foi?">
                <select id="input-cat" class="w-full border-b py-3 outline-none bg-transparent font-semibold"></select>
                <button onclick="saveTransaction()" class="w-full btn-primary py-5 rounded-3xl font-bold shadow-xl">Salvar Registro</button>
            </div>
        </div>
    </div>

    <div id="modal-goal" class="fixed inset-0 bg-black/50 hidden z-[100] flex items-end justify-center">
        <div class="bg-white w-full max-w-sm rounded-t-[40px] p-8 space-y-6 modal-enter">
            <h3 class="font-bold text-xl">Configurar Meta</h3>
            <input type="hidden" id="goal-id">
            <input type="text" id="goal-title" class="w-full border-b py-3 outline-none" placeholder="Nome da Meta">
            <input type="text" id="goal-target" class="w-full border-b py-3 outline-none font-bold" placeholder="Valor Alvo" inputmode="decimal">
            <input type="text" id="goal-current" class="w-full border-b py-3 outline-none font-bold" placeholder="JÃ¡ tem?" inputmode="decimal">
            <div class="flex gap-2">
                <button id="btn-delete-goal" onclick="deleteGoal()" class="flex-1 bg-slate-100 text-slate-400 py-4 rounded-2xl font-bold">Excluir</button>
                <button onclick="saveGoal()" class="flex-[2] btn-primary py-4 rounded-2xl font-bold">Salvar Meta</button>
            </div>
        </div>
    </div>

    <div id="modal-future" class="fixed inset-0 bg-black/50 hidden z-[100] flex items-end justify-center">
        <div class="bg-white w-full max-w-sm rounded-t-[40px] p-8 space-y-6 modal-enter">
            <h3 class="font-bold text-xl">Agendar Gasto ðŸ“…</h3>
            <input type="date" id="future-date" class="w-full border-b py-3 outline-none font-bold">
            <input type="text" id="future-amount" class="w-full border-b py-3 outline-none font-bold" placeholder="Valor R$" inputmode="decimal">
            <input type="text" id="future-desc" class="w-full border-b py-3 outline-none" placeholder="O que serÃ¡?">
            <button onclick="saveFuture()" class="w-full btn-primary py-5 rounded-3xl font-bold shadow-xl">Agendar</button>
        </div>
    </div>

    <script>
        // CentralizaÃ§Ã£o do estado para evitar perdas
        const state = {
            transactions: JSON.parse(localStorage.getItem('fdb_transactions')) || [],
            goals: JSON.parse(localStorage.getItem('fdb_goals')) || [],
            futureTxs: JSON.parse(localStorage.getItem('fdb_future')) || [],
            user: JSON.parse(localStorage.getItem('fdb_user')) || { name: 'UsuÃ¡ria', password: '', lastAccess: null }
        };
        
        let chart = null;
        const apiKey = ""; 

        window.onload = () => {
            lucide.createIcons();
            if (state.user.password) {
                document.getElementById('lock-screen').classList.remove('hidden');
            } else {
                completeLogin();
            }
            loadSettingsToUI();
        };

        // MOTOR DE SINCRONIZAÃ‡ÃƒO REFORÃ‡ADO
        function sync() {
            try {
                localStorage.setItem('fdb_transactions', JSON.stringify(state.transactions));
                localStorage.setItem('fdb_goals', JSON.stringify(state.goals));
                localStorage.setItem('fdb_future', JSON.stringify(state.futureTxs));
                localStorage.setItem('fdb_user', JSON.stringify(state.user));
                return true;
            } catch (e) {
                console.error("Falha no LocalStorage:", e);
                alert("Erro ao gravar dados! Verifique se vocÃª estÃ¡ em modo privado ou se o iPhone estÃ¡ sem espaÃ§o.");
                return false;
            }
        }

        function completeLogin() {
            document.getElementById('lock-screen').classList.add('hidden');
            const last = state.user.lastAccess ? new Date(state.user.lastAccess).toLocaleString('pt-BR') : 'Bem-vinda!';
            document.getElementById('header-subtitle').innerText = `Oi, ${state.user.name}! Acesso: ${last}`;
            state.user.lastAccess = new Date().toISOString();
            sync();
            updateUI();
        }

        function unlockApp() {
            if (document.getElementById('unlock-pass').value === state.user.password) completeLogin();
            else alert('PIN errado! Tenta novamente.');
        }

        function updateUI() {
            const inc = state.transactions.filter(t => t.amount > 0).reduce((a,b) => a + b.amount, 0);
            const exp = state.transactions.filter(t => t.amount < 0).reduce((a,b) => a + Math.abs(b.amount), 0);
            
            document.getElementById('total-balance').innerText = formatCurrency(inc - exp);
            document.getElementById('total-income').innerText = formatCurrency(inc);
            document.getElementById('total-expense').innerText = formatCurrency(exp);
            
            renderChart();
            renderCategoryTables();
            renderGoals();
            renderFuture();
            lucide.createIcons();
        }

        function renderChart() {
            const expOnly = state.transactions.filter(t => t.amount < 0);
            const container = document.getElementById('evolution-container');
            const empty = document.getElementById('chart-empty');
            
            if (expOnly.length === 0) {
                container.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }
            container.classList.remove('hidden');
            empty.classList.add('hidden');

            const groups = {};
            expOnly.forEach(t => {
                const d = new Date(t.date).toLocaleDateString('pt-BR');
                groups[d] = (groups[d] || 0) + Math.abs(t.amount);
            });
            const labels = Object.keys(groups).sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-'))).slice(-7);
            const data = labels.map(l => groups[l]);

            const ctx = document.getElementById('evolutionChart').getContext('2d');
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ data, backgroundColor: '#ec4899', borderRadius: 8 }] },
                options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false } } } }
            });
        }

        function parseNum(val) {
            if (!val) return 0;
            const clean = val.toString().replace(',', '.').trim();
            return parseFloat(clean) || 0;
        }

        function openModal(t) {
            window.currentType = t;
            // GARANTE QUE O MODAL ABRA LIMPO
            document.getElementById('input-amount').value = '';
            document.getElementById('input-desc').value = '';
            document.getElementById('modal-title').innerText = t === 'expense' ? 'ðŸ’¸ Novo Gasto' : 'ðŸ’° Nova Entrada';
            document.getElementById('input-cat').innerHTML = (t === 'expense' ? ['AlimentaÃ§Ã£o', 'Casa', 'SaÃºde', 'Lazer', 'Outros'] : ['SalÃ¡rio', 'Extra', 'TransferÃªncia']).map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('modal-transaction').classList.remove('hidden');
            setTimeout(() => document.getElementById('input-amount').focus(), 200);
        }

        function closeModal() { document.getElementById('modal-transaction').classList.add('hidden'); }

        function saveTransaction() {
            const amt = parseNum(document.getElementById('input-amount').value);
            const desc = document.getElementById('input-desc').value;
            const cat = document.getElementById('input-cat').value;

            if (amt <= 0 || !desc) return alert('Preecha os campos! ðŸ˜Š');

            state.transactions.push({ 
                id: Date.now(), 
                amount: window.currentType === 'expense' ? -amt : amt, 
                desc, category: cat, date: new Date().toISOString() 
            });
            
            if(sync()) {
                closeModal();
                updateUI();
                showToast('Salvo! âœ¨');
            }
        }

        function renderCategoryTables() {
            const container = document.getElementById('category-list');
            container.innerHTML = state.transactions.length === 0 ? '<p class="text-center text-slate-400 py-10 italic">Sem registros.</p>' : "";
            const cats = [...new Set(state.transactions.map(t => t.category))];
            cats.forEach(cat => {
                const items = state.transactions.filter(t => t.category === cat).sort((a,b) => new Date(b.date) - new Date(a.date));
                const sum = items.reduce((a,b) => a + b.amount, 0);
                container.innerHTML += `
                    <div class="glass-card rounded-2xl overflow-hidden mb-4">
                        <div class="p-4 bg-gray-50 flex justify-between font-bold border-b text-sm">
                            <span>${cat}</span><span class="${sum < 0 ? 'text-rose-500' : 'text-emerald-500'}">${formatCurrency(sum)}</span>
                        </div>
                        <div class="p-2 space-y-1">
                            ${items.map(i => `
                                <div class="flex justify-between p-2 text-[10px] border-b last:border-0 border-slate-50 items-center">
                                    <span class="text-slate-400 w-16">${new Date(i.date).toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})}</span>
                                    <span class="flex-1 px-4 text-slate-700 font-medium">${i.desc}</span>
                                    <span class="font-bold ${i.amount < 0 ? 'text-rose-400' : 'text-emerald-500'}">${formatCurrency(i.amount)}</span>
                                </div>`).join('')}
                        </div>
                    </div>`;
            });
        }

        function renderGoals() {
            const container = document.getElementById('goals-container');
            container.innerHTML = state.goals.length === 0 ? '<p class="text-center text-slate-400 py-10 italic">Nenhuma meta criada.</p>' : "";
            state.goals.forEach(goal => {
                const percent = Math.min(100, (goal.current / goal.target) * 100);
                container.innerHTML += `
                    <div class="glass-card rounded-3xl p-5 relative cursor-pointer active:scale-95 transition-transform" onclick='openGoalModal(${JSON.stringify(goal)})'>
                        <div class="absolute top-4 right-4 text-slate-300"><i data-lucide="pencil" class="w-4 h-4"></i></div>
                        <h4 class="font-bold text-slate-800 mb-2">${goal.title}</h4>
                        <div class="h-2 bg-slate-100 rounded-full overflow-hidden mb-2">
                            <div class="h-full bg-pink-500" style="width: ${percent}%"></div>
                        </div>
                        <div class="flex justify-between text-[10px] font-bold text-slate-400">
                            <span>${formatCurrency(goal.current)}</span><span>Meta: ${formatCurrency(goal.target)}</span>
                        </div>
                    </div>`;
            });
            lucide.createIcons();
        }

        function saveGoal() {
            const id = document.getElementById('goal-id').value;
            const newGoal = {
                id: id ? Number(id) : Date.now(),
                title: document.getElementById('goal-title').value,
                target: parseNum(document.getElementById('goal-target').value),
                current: parseNum(document.getElementById('goal-current').value)
            };
            if(!newGoal.title || newGoal.target <= 0) return alert('DÃª um nome e valor!');
            if(id) state.goals = state.goals.map(g => g.id == id ? newGoal : g);
            else state.goals.push(newGoal);
            if(sync()) { closeGoalModal(); updateUI(); showToast('Meta guardada! ðŸŽ¯'); }
        }

        function deleteGoal() {
            const id = document.getElementById('goal-id').value;
            if(!id) return;
            state.goals = state.goals.filter(g => g.id != id);
            sync(); closeGoalModal(); updateUI();
        }

        function renderFuture() {
            const container = document.getElementById('future-list');
            container.innerHTML = state.futureTxs.length === 0 ? '<p class="text-center text-slate-400 py-10">Nada planejado.</p>' : '';
            state.futureTxs.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(tx => {
                container.innerHTML += `
                    <div class="glass-card p-4 rounded-2xl flex justify-between items-center">
                        <div>
                            <p class="text-[10px] font-bold text-indigo-500">${new Date(tx.date).toLocaleDateString()}</p>
                            <p class="font-bold text-slate-700">${tx.desc}</p>
                        </div>
                        <div class="text-right flex flex-col items-end">
                            <span class="font-bold text-slate-800">${formatCurrency(tx.amount)}</span>
                            <button onclick="deleteFuture(${tx.id})" class="text-rose-300 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>`;
            });
            lucide.createIcons();
        }

        function saveFuture() {
            const date = document.getElementById('future-date').value;
            const amount = parseNum(document.getElementById('future-amount').value);
            const desc = document.getElementById('future-desc').value;
            if(!date || amount <= 0 || !desc) return alert('Preecha tudo!');
            state.futureTxs.push({ id: Date.now(), date, amount, desc });
            if(sync()) { closeFutureModal(); updateUI(); showToast('Agendado! ðŸ“…'); }
        }

        function deleteFuture(id) {
            state.futureTxs = state.futureTxs.filter(f => f.id !== id);
            sync(); updateUI();
        }

        function toggleView(v) {
            ['home', 'list', 'future', 'goals', 'import', 'settings'].forEach(view => {
                const el = document.getElementById(`view-${view}`);
                if (el) el.classList.add('hidden');
            });
            document.getElementById(`view-${v}`).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-active'));
            updateUI();
        }

        function showToast(m) {
            const t = document.getElementById('toast');
            document.getElementById('toast-text').innerText = m;
            t.style.display = 'flex';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        function formatCurrency(v) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v); }
        function openGoalModal(g = null) {
            document.getElementById('goal-id').value = g ? g.id : "";
            document.getElementById('goal-title').value = g ? g.title : "";
            document.getElementById('goal-target').value = g ? g.target : "";
            document.getElementById('goal-current').value = g ? g.current : "";
            document.getElementById('btn-delete-goal').classList.toggle('hidden', !g);
            document.getElementById('modal-goal').classList.remove('hidden');
        }
        function closeGoalModal() { document.getElementById('modal-goal').classList.add('hidden'); }
        function openFutureModal() { document.getElementById('modal-future').classList.remove('hidden'); }
        function closeFutureModal() { document.getElementById('modal-future').classList.add('hidden'); }
        function loadSettingsToUI() { document.getElementById('set-user-name').value = state.user.name; }
        
        function saveSettings() {
            state.user.name = document.getElementById('set-user-name').value || 'UsuÃ¡ria';
            const pass = document.getElementById('set-user-pass').value;
            if(pass) state.user.password = pass;
            if(sync()) { alert('Salvo!'); completeLogin(); }
        }

        function clearAllData() {
            if(confirm("CUIDADO: Isso vai apagar TODOS os seus dados salvos. Continuar?")) {
                localStorage.clear();
                location.reload();
            }
        }

        async function generateAdvice() {
            const resBox = document.getElementById('advice-result');
            resBox.classList.remove('hidden');
            resBox.innerText = "IA pensando... ðŸ§ ";
            const inc = state.transactions.filter(t => t.amount > 0).reduce((a,b) => a + b.amount, 0);
            const exp = state.transactions.filter(t => t.amount < 0).reduce((a,b) => a + Math.abs(b.amount), 0);
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `DÃª 3 conselhos curtos para saldo ${inc-exp} e gastos de ${exp}.` }] }],
                        systemInstruction: { parts: [{ text: `Seja uma mentora financeira gentil para mulheres de humanas. Use emojis.` }] }
                    })
                });
                const data = await response.json();
                resBox.innerText = data.candidates[0].content.parts[0].text;
            } catch (e) { resBox.innerText = "IA indisponÃ­vel sem internet."; }
        }

        async function processMagicImport() {
            const text = document.getElementById('import-input').value;
            if(!text) return alert("Cole o texto!");
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Extraia JSON de: ${text}` }] }],
                        systemInstruction: { parts: [{ text: `Retorne apenas JSON array: [{"desc":string, "amount":number, "category":string}].` }] }
                    })
                });
                const data = await response.json();
                const items = JSON.parse(data.candidates[0].content.parts[0].text);
                items.forEach(i => state.transactions.push({ ...i, id: Date.now()+Math.random(), date: new Date().toISOString() }));
                sync();
                showToast('Importado! âœ¨');
                toggleView('home');
            } catch (e) { alert("Erro ao importar."); }
        }
    </script>
</body>
</html>
